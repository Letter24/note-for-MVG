# 仿射对极几何

本章主要是在仿射摄像机的情况下重新考虑对极几何.
仿射摄像机的优点是他是线性的, 所以很多最优化算法可以用线性代数的知识解决. 如果是一般的投影摄像机, 很多算法就不是线性的了, 比如三角化.

## 14.1 仿射对极几何

仿射摄像机的特点是它的光心在无穷远, 所以从三维空间像二维平面投影时, 投影射线时互相平行的. 在这种情况下, 对极几何就可以得到简化.

**极线** 所有极线都是互相平行的. 因为不同点向图像投影的射线是平行的

**极点** 因为所有极线互相平行, 那么极点在无穷远处.

## 14.2 仿射基本矩阵

仿射基本矩阵$F_A$长这样

$$
\left[
\begin{matrix}
0 & 0 & a \\
0 & 0 & b \\
c & d & e \\
\end{matrix}
\right]
$$
因为$a,b,c,d,e$都不为0, 那么$F_A$的秩就是3, 一般的$F$秩是2

## 14.2.1 $F_A$的推导过程


**从几何角度推导$F_A$的过程**
1. 考虑对应点之间的对应关系. 因为从图像1到空间平面,再到图像2的所有变换都是基于平面的仿射变换, 所以对应点之间的变换也是仿射变换, 也就是$x'=H_A x$
2. 构造极线. 极线是通过极点和$x'$构造的. 所以$l'=e' \times H_A x =F_A x$, 所以$F_A=[e']_{\times} H_A$, 具体展开如下:

$$
F_A =[e']_{\times} H_A \\ 
= \left[
      \begin{matrix}
      0 & 0 & * \\     
      0 & 0 & * \\
      * & * & 0 \\
      \end{matrix}
  \right] 

  \left[
      \begin{matrix}
      * & * & * \\ 
      * & * & * \\
      0 & 0 & 1 \\
      \end{matrix}
  \right]            \\

= \left[
      \begin{matrix}
      0 & 0 & * \\ 
      0 & 0 & * \\
      * & * & * \\
      \end{matrix}
  \right]
$$


**从代数角度推导$F_A$的过程**

$F=[e']_{\times}P'P^{+}$, 把仿射摄像机的矩阵带入即可.

## 14.2.2 性质

$F_A$四个自由度, 两个极点,每个贡献一个自由度. 两个平面上的极线互相映射, 贡献两个自由度.

因为$F_A e = 0$, 所以极点表示为(-d,c,0), 所以$e$在$l_{\infty}$
点$x$对应的极线$l'=F_A x=(a,b,cx+dy+e)^T$, 此式表明所有的极线都是平行的, 因为$(a,b)$与$(x,y)$互相独立

## 14.3 从对应点中计算$F_A$

因为$F_A$规定了点与点之间的对应关系, 所以给出足够过的点, 肯定是能把$F_A$计算出来的. 比如我们规定$x_i=(x_i,y_i,1), x'_i=(x'_i,y'_i,1)$. 这样一对对应点可以构造一个线性方程
$$
ax'_i+by'_i+cx_i+dy_i+e=0
$$

写成矩阵形式就是$Af=0$, $A$是一个$n \times 5$的矩阵, 最少需要4对点, 而不是5. $F_A$四个自由度, 剩下的一个变量可由其他四个来表示.

**奇异性约束**

我们知道一般情况的$F$是奇异矩阵, 所以$F_A$也应该是一个奇异性矩阵. 而且$F_A$的形式就确定了它的rank不会大于2, 所以没有必要将奇异性约束像求普通$F$那样加入求解的过程, 换言之, 不用考虑这恶个约束, 直接求解就可以了.

**几何解释**

求解两个图像上的对应点就是在四位空间中去拟合一个平面 ($ax'_i+by'_i+cx_i+dy_i+e=0$ 就是四维空间中的平面). 这样做有两个好处: 第一, 求$F$就是一个平面拟合过程, 容易思考. 第二可以用sampson损失函数, 因为它是唯一的一个一阶近似方法. 

## 黄金标准算法

知道了求解$F$的几何解释, 我们就用这个几何解释来求解它. 求解的过程就是黄金标准算法. 我们考虑有噪声的情况, 理论点可以表示为$\hat{x_i},\hat{x_i}'$, 实际观测点是$x_i,x'_i$, 所谓的黄金标准算法就是优化以下函数:

$$
min \sum_{i} d(x_i,\hat{x_i})^2 + d(x'_i,\hat{x_i}')^2 
$$

其中$\hat{x_i},\hat{x_i}'$满足$\hat{x_i} F_A \hat{x_i}'$, 如果我们考虑几何解释, 我们就可以考虑四维空间的一个点$X_i=(x'_i,y'_i,x_i,y_i)$,用这个点去拟合一个平面,其参数为$(a,b,c,d,e)$, 那么就是求点到平面的最小距离.
$$
d_{\perp} = \frac{ax'_i,by'_i+cx_i+dy_i+e}{\sqrt{a^2+b^2+c^2+d^2}}
$$

求解这个函数的过程如下:
先对$e$求导数, 令其等于0, 可以得到
$$
e=-\frac{1}{n} \sum(N^T X_i) = -N \bar{X}
$$

$$
N=(a,b,c,d)
$$

$\bar{N}$就是所有已知$X$的均值, 也就是质心.

把$e$反带回$d_{\perp}$ 得到

$$
d_{\perp} = \frac{1}{||N||^2} \sum_i(N^T \Delta X_i)
$$

$$
\Delta X_i = X_i - \bar{X} 
$$

用$\Delta X_i$的行构造一个矩阵, 然后直接SVD分解就可以了.
最后一个需要注意的点: 黄金标准算法需要多于4对对应点. 那么如果我们只知道4对对应点, 该怎那么办? 下面的算法来解决.

## 4对对应点求解$F_A$

步骤如下:
1. 用前三对对应点计算一个仿射变换$H_A$, 也就是求解$x'_i=H_A x_i$
2. 用$H_A$计算$H_A x_4$, 然后$(H_A x_4 \times x'_4)$ 得到极线$l'$
   那么极点就是$e'=(-l'_2,l'_1,0)$
3. 所以对任何一个点$x$, 它对应的极线就是$e' \times (H_A x) = F_A x$

# 14.4 三角化

现在假设我们知道一对对应点$(x,y) \leftrightarrow (x',y')$ 和仿射基本矩阵$F_A$, 因为已知对应点是含噪声的, 我们想要确定不含噪声的点$(\hat{x},\hat{y}) \leftrightarrow (\hat{x}',\hat{y}')$ 所以我们得到一个带约束的优化

$$
(x-\hat{x})^2 + (y-\hat{y})^2 + (x'-\hat{x}')^2 + (y-\hat{y}')^2
$$

同时

$$
(\hat{x},\hat{y},1) F_A (\hat{x}',\hat{y}',1) = 0
$$

那么怎么样求解呢? 除了几何解释的求解法以外, 我们还可以用sampson损失函数

$$
\begin{pmatrix} 
  \hat{x}' \\
  \hat{y}' \\
  \hat{x} \\
  \hat{y} \\
\end{pmatrix}
=
\begin{pmatrix} 
  x' \\
  y' \\
  x \\
  y \\
\end{pmatrix}
- \frac{ax'+by'+cx+dy+e}{a^2+b^2+c^2+d^2}
\begin{pmatrix} 
  a \\
  b \\
  c \\
  d \\
\end{pmatrix}
$$

# 14.5 仿射重建